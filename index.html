<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trena por C√¢mera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }
        
        /* Container principal */
        .app-container {
            height: 100vh;
            position: relative;
        }
        
        /* Cabe√ßalho */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 1.4rem;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* √Årea da c√¢mera - ocupa toda a tela */
        .camera-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        #camera-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Overlay de medi√ß√£o */
        .measure-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        /* Bot√£o de adicionar ponto no centro */
        .center-point-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70px;
            height: 70px;
            background: rgba(0, 255, 136, 0.9);
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            user-select: none;
            transition: transform 0.2s;
        }
        
        .center-point-btn:active {
            transform: translate(-50%, -50%) scale(0.95);
        }
        
        /* Pontos de medi√ß√£o */
        .measure-point {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ff3366;
            border: 3px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.8);
        }
        
        .point-number {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            min-width: 25px;
            text-align: center;
            border: 1px solid white;
        }
        
        /* Linhas de medi√ß√£o */
        .measure-line {
            position: absolute;
            background: rgba(0, 255, 136, 0.7);
            transform-origin: 0 0;
            z-index: 20;
            pointer-events: none;
        }
        
        /* Label de medida */
        .measure-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff88;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            border: 2px solid #00ff88;
            z-index: 40;
            white-space: nowrap;
            transform: translate(-50%, -50%);
        }
        
        /* Painel de controle */
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border-top: 1px solid #333;
        }
        
        /* Display de medi√ß√µes */
        .measure-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
        }
        
        .measure-item {
            text-align: center;
        }
        
        .measure-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ff88;
            line-height: 1;
        }
        
        .measure-unit {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 3px;
        }
        
        /* Bot√µes de a√ß√£o */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .action-btn {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .btn-add {
            background: #00ff88;
            color: #000;
            grid-column: span 2;
        }
        
        .btn-clear {
            background: #ff3366;
        }
        
        .btn-camera {
            background: #3366ff;
        }
        
        .btn-reset {
            background: #ff9900;
            grid-column: span 3;
            margin-top: 5px;
        }
        
        /* Modal de permiss√£o */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .permission-content {
            background: #222;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }
        
        .permission-content h2 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .permission-content p {
            margin-bottom: 20px;
            line-height: 1.5;
            font-size: 1.1rem;
        }
        
        .permission-btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 18px 40px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Instru√ß√µes */
        .instructions {
            position: absolute;
            top: 80px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            border-left: 4px solid #00ff88;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        /* Anima√ß√µes */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        /* Status da c√¢mera */
        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 100;
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üìè TRENA POR C√ÇMERA</h1>
            <p>Toque no bot√£o verde para adicionar pontos de medi√ß√£o</p>
        </div>
        
        <div class="camera-area">
            <video id="camera-view" autoplay playsinline></video>
            <div class="measure-overlay" id="measure-overlay">
                <!-- Pontos e linhas ser√£o adicionados aqui -->
            </div>
            <div class="center-point-btn" id="center-point-btn">
                +
            </div>
        </div>
        
        <div class="instructions" id="instructions">
            <strong>Como usar:</strong> Aponte a c√¢mera, toque no bot√£o verde para adicionar pontos. Mova o celular e adicione mais pontos para medir.
        </div>
        
        <div class="camera-status" id="camera-status">
            C√¢mera: Traseira
        </div>
        
        <div class="control-panel">
            <div class="measure-display">
                <div class="measure-item">
                    <div class="measure-value" id="distance-value">0.00</div>
                    <div class="measure-unit">METROS</div>
                </div>
                <div class="measure-item">
                    <div class="measure-value" id="area-value">0.00</div>
                    <div class="measure-unit">M¬≤</div>
                </div>
                <div class="measure-item">
                    <div class="measure-value" id="points-value">0</div>
                    <div class="measure-unit">PONTOS</div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="action-btn btn-add" id="add-point-btn">
                    <span style="font-size: 1.3rem;">+</span> Adicionar Ponto
                </button>
                <button class="action-btn btn-clear" id="clear-btn">
                    üóëÔ∏è Limpar
                </button>
                <button class="action-btn btn-camera" id="switch-camera-btn">
                    üîÑ C√¢mera
                </button>
                <button class="action-btn btn-reset" id="reset-btn">
                    üîÑ Reiniciar
                </button>
            </div>
        </div>
        
        <!-- Modal de permiss√£o -->
        <div class="permission-modal" id="permission-modal">
            <div class="permission-content">
                <h2>üì∑ PERMISS√ÉO DA C√ÇMERA</h2>
                <p>Para usar a trena, precisamos acessar sua c√¢mera.</p>
                <p>Aponte para o que quer medir e adicione pontos tocando no bot√£o verde.</p>
                <button class="permission-btn" id="start-camera-btn">
                    ATIVAR C√ÇMERA
                </button>
            </div>
        </div>
    </div>

    <script>
        // Elementos principais
        const cameraView = document.getElementById('camera-view');
        const measureOverlay = document.getElementById('measure-overlay');
        const centerPointBtn = document.getElementById('center-point-btn');
        const distanceValue = document.getElementById('distance-value');
        const areaValue = document.getElementById('area-value');
        const pointsValue = document.getElementById('points-value');
        const permissionModal = document.getElementById('permission-modal');
        const instructions = document.getElementById('instructions');
        const cameraStatus = document.getElementById('camera-status');
        
        // Bot√µes
        const startCameraBtn = document.getElementById('start-camera-btn');
        const addPointBtn = document.getElementById('add-point-btn');
        const clearBtn = document.getElementById('clear-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Estado da aplica√ß√£o
        let cameraStream = null;
        let isCameraActive = false;
        let isFrontCamera = false;
        let points = [];
        let lines = [];
        let labels = [];
        let pointCounter = 0;
        
        // Iniciar c√¢mera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: isFrontCamera ? "user" : "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraView.srcObject = cameraStream;
                isCameraActive = true;
                
                // Esconder modal
                permissionModal.classList.add('hidden');
                
                // Esconder instru√ß√µes ap√≥s 5 segundos
                setTimeout(() => {
                    instructions.classList.add('hidden');
                }, 5000);
                
                console.log("C√¢mera iniciada com sucesso!");
                
            } catch (error) {
                console.error("Erro na c√¢mera:", error);
                alert("N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.");
            }
        }
        
        // Adicionar ponto de medi√ß√£o
        function addMeasurementPoint() {
            if (!isCameraActive) {
                alert("Ative a c√¢mera primeiro!");
                return;
            }
            
            pointCounter++;
            
            // Posi√ß√£o do ponto (no centro da tela)
            const x = 50; // porcentagem
            const y = 50; // porcentagem
            
            // Criar ponto
            const point = {
                id: pointCounter,
                x: x,
                y: y,
                element: null,
                label: null
            };
            
            // Criar elemento visual do ponto
            createPointElement(point);
            
            // Adicionar ao array
            points.push(point);
            
            // Atualizar interface
            updatePointsDisplay();
            
            // Se tiver pelo menos 2 pontos, criar linha e calcular
            if (points.length >= 2) {
                const lastPoint = points[points.length - 2];
                const currentPoint = points[points.length - 1];
                
                createLine(lastPoint, currentPoint);
                calculateDistance();
            }
            
            // Se tiver pelo menos 3 pontos, calcular √°rea
            if (points.length >= 3) {
                calculateArea();
            }
            
            // Animar o bot√£o
            centerPointBtn.classList.add('pulse');
            setTimeout(() => {
                centerPointBtn.classList.remove('pulse');
            }, 500);
        }
        
        // Criar elemento visual do ponto
        function createPointElement(point) {
            const pointElement = document.createElement('div');
            pointElement.className = 'measure-point pulse';
            pointElement.style.left = `${point.x}%`;
            pointElement.style.top = `${point.y}%`;
            
            // N√∫mero do ponto
            const numberElement = document.createElement('div');
            numberElement.className = 'point-number';
            numberElement.textContent = point.id;
            pointElement.appendChild(numberElement);
            
            // Adicionar ao overlay
            measureOverlay.appendChild(pointElement);
            point.element = pointElement;
        }
        
        // Criar linha entre dois pontos
        function createLine(pointA, pointB) {
            // Calcular dist√¢ncia entre pontos
            const dx = pointB.x - pointA.x;
            const dy = pointB.y - pointA.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * (180 / Math.PI);
            
            // Criar elemento da linha
            const lineElement = document.createElement('div');
            lineElement.className = 'measure-line';
            lineElement.style.left = `${pointA.x}%`;
            lineElement.style.top = `${pointA.y}%`;
            lineElement.style.width = `${distance}%`;
            lineElement.style.height = '4px';
            lineElement.style.transform = `rotate(${angle}deg)`;
            lineElement.style.transformOrigin = '0 0';
            
            measureOverlay.appendChild(lineElement);
            lines.push(lineElement);
            
            // Criar label da medida
            createMeasureLabel(pointA, pointB, distance, angle);
        }
        
        // Criar label da medida
        function createMeasureLabel(pointA, pointB, distance, angle) {
            // Posi√ß√£o do label (meio da linha)
            const midX = (pointA.x + pointB.x) / 2;
            const midY = (pointA.y + pointB.y) / 2;
            
            // Converter dist√¢ncia para metros (simula√ß√£o)
            // Na pr√°tica, isso precisaria de calibra√ß√£o com objeto real
            const distanceInMeters = (distance * 0.02).toFixed(2);
            
            // Criar elemento do label
            const labelElement = document.createElement('div');
            labelElement.className = 'measure-label';
            labelElement.textContent = `${distanceInMeters} m`;
            labelElement.style.left = `${midX}%`;
            labelElement.style.top = `${midY}%`;
            
            // Rotacionar label para ficar leg√≠vel
            labelElement.style.transform = `translate(-50%, -50%) rotate(${-angle}deg)`;
            
            measureOverlay.appendChild(labelElement);
            labels.push(labelElement);
        }
        
        // Calcular dist√¢ncia total
        function calculateDistance() {
            if (points.length < 2) {
                distanceValue.textContent = '0.00';
                return;
            }
            
            let totalDistance = 0;
            
            // Calcular soma de todas as dist√¢ncias entre pontos consecutivos
            for (let i = 1; i < points.length; i++) {
                const pointA = points[i-1];
                const pointB = points[i];
                
                const dx = pointB.x - pointA.x;
                const dy = pointB.y - pointA.y;
                const segmentDistance = Math.sqrt(dx * dx + dy * dy);
                
                // Converter para metros
                totalDistance += segmentDistance * 0.02;
            }
            
            distanceValue.textContent = totalDistance.toFixed(2);
        }
        
        // Calcular √°rea
        function calculateArea() {
            if (points.length < 3) {
                areaValue.textContent = '0.00';
                return;
            }
            
            // F√≥rmula do pol√≠gono (Shoelace)
            let area = 0;
            
            for (let i = 0; i < points.length; i++) {
                const j = (i + 1) % points.length;
                area += points[i].x * points[j].y;
                area -= points[j].x * points[i].y;
            }
            
            area = Math.abs(area / 2);
            
            // Converter para metros quadrados
            const areaInM2 = (area * 0.0004).toFixed(2);
            areaValue.textContent = areaInM2;
        }
        
        // Atualizar contador de pontos
        function updatePointsDisplay() {
            pointsValue.textContent = points.length;
        }
        
        // Limpar todas as medi√ß√µes
        function clearMeasurements() {
            // Remover elementos visuais
            points.forEach(point => {
                if (point.element && point.element.parentNode) {
                    point.element.parentNode.removeChild(point.element);
                }
            });
            
            lines.forEach(line => {
                if (line.parentNode) {
                    line.parentNode.removeChild(line);
                }
            });
            
            labels.forEach(label => {
                if (label.parentNode) {
                    label.parentNode.removeChild(label);
                }
            });
            
            // Limpar arrays
            points = [];
            lines = [];
            labels = [];
            pointCounter = 0;
            
            // Atualizar interface
            distanceValue.textContent = '0.00';
            areaValue.textContent = '0.00';
            updatePointsDisplay();
        }
        
        // Alternar entre c√¢meras
        async function switchCamera() {
            if (!cameraStream) return;
            
            // Parar c√¢mera atual
            cameraStream.getTracks().forEach(track => track.stop());
            
            // Alternar tipo
            isFrontCamera = !isFrontCamera;
            
            // Limpar medi√ß√µes
            clearMeasurements();
            
            // Atualizar status
            cameraStatus.textContent = `C√¢mera: ${isFrontCamera ? 'Frontal' : 'Traseira'}`;
            
            // Iniciar nova c√¢mera
            await startCamera();
        }
        
        // Reiniciar tudo
        function resetAll() {
            clearMeasurements();
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                isCameraActive = false;
            }
            
            // Mostrar modal novamente
            permissionModal.classList.remove('hidden');
            isFrontCamera = false;
            cameraStatus.textContent = 'C√¢mera: Traseira';
            instructions.classList.remove('hidden');
        }
        
        // Event Listeners
        startCameraBtn.addEventListener('click', startCamera);
        centerPointBtn.addEventListener('click', addMeasurementPoint);
        addPointBtn.addEventListener('click', addMeasurementPoint);
        clearBtn.addEventListener('click', clearMeasurements);
        switchCameraBtn.addEventListener('click', switchCamera);
        resetBtn.addEventListener('click', resetAll);
        
        // Permitir tocar em qualquer lugar do overlay para adicionar ponto
        measureOverlay.addEventListener('click', function(e) {
            // N√£o adicionar ponto se clicar no bot√£o central
            if (e.target === centerPointBtn || centerPointBtn.contains(e.target)) {
                return;
            }
            
            // Calcular posi√ß√£o em porcentagem
            const rect = measureOverlay.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            // Adicionar ponto na posi√ß√£o clicada
            addPointAtPosition(x, y);
        });
        
        // Fun√ß√£o para adicionar ponto em posi√ß√£o espec√≠fica
        function addPointAtPosition(x, y) {
            if (!isCameraActive) {
                alert("Ative a c√¢mera primeiro!");
                return;
            }
            
            pointCounter++;
            
            // Criar ponto
            const point = {
                id: pointCounter,
                x: x,
                y: y,
                element: null,
                label: null
            };
            
            // Criar elemento visual do ponto
            createPointElement(point);
            
            // Posicionar ponto
            point.element.style.left = `${x}%`;
            point.element.style.top = `${y}%`;
            point.element.querySelector('.point-number').textContent = pointCounter;
            
            // Adicionar ao array
            points.push(point);
            
            // Atualizar interface
            updatePointsDisplay();
            
            // Se tiver pelo menos 2 pontos, criar linha e calcular
            if (points.length >= 2) {
                const lastPoint = points[points.length - 2];
                const currentPoint = points[points.length - 1];
                
                createLine(lastPoint, currentPoint);
                calculateDistance();
            }
            
            // Se tiver pelo menos 3 pontos, calcular √°rea
            if (points.length >= 3) {
                calculateArea();
            }
        }
        
        // Feedback t√°til para mobile
        const actionButtons = document.querySelectorAll('.action-btn');
        actionButtons.forEach(btn => {
            btn.addEventListener('touchstart', function() {
                this.style.opacity = '0.7';
            });
            
            btn.addEventListener('touchend', function() {
                this.style.opacity = '1';
            });
        });
        
        // Prevenir zoom com dois dedos
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            // Verificar se temos permiss√£o de c√¢mera
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log("API de c√¢mera dispon√≠vel");
            } else {
                alert("Seu navegador n√£o suporta acesso √† c√¢mera.");
            }
        });
        
        // Pausar c√¢mera quando a p√°gina n√£o estiver vis√≠vel
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && cameraStream) {
                cameraStream.getTracks().forEach(track => track.pause());
            } else if (!document.hidden && cameraStream) {
                cameraStream.getTracks().forEach(track => track.resume());
            }
        });
    </script>
</body>
</html>
